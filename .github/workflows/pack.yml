name: pack

on:
  push:
    branches:
      - main
    tags:
      # tag must be rust_version-mkl_version
      - "*.*.*-*.*"
  pull_request:
    branches:
      - main

jobs:
  linux:
    runs-on: ubuntu-22.04
    container:
      image: rust:1.63.0
    steps:
      - uses: actions/checkout@v1

      - uses: actions-rs/cargo@v1
        with:
          command: install
          args: ocipkg-cli --version=~0.2
      - name: Add path
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        run: |
          ocipkg login -u ${{ github.repository_owner }} -p ${{ github.token }} https://ghcr.io

      - name: Install Intel MKL
        run: |
          apt update
          apt install -y cpio
          ./install-mkl.sh

      - name: Create oci-archive using intel-mkl-pack
        uses: actions-rs/cargo@v1
        with:
          command: run
          args: --release

      - name: Push oci-archives
        if: github.event_name != 'pull_request'
        run: >-
          for ar in $(find . -name "mkl-*-*-*.tar"); do
            ocipkg push $ar;
          done

  windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v1
      - name: Get MKL using NuGet
        run: |
          nuget install intelmkl.devel.cluster.win-x64  -Version 2022.0.3.171
          nuget install intelmkl.static.cluster.win-x64 -Version 2022.0.3.171
      - name: Add DLL runtime path
        run: |
          echo "${{ github.workspace }}/intelmkl.redist.win-x64.2022.0.3.171/runtimes/win-x64/native" >> $Env:GITHUB_PATH
          echo "${{ github.workspace }}/intelopenmp.redist.win.2022.0.0.3663/runtimes/win-x64/native" >> $Env:GITHUB_PATH
      - uses: actions-rs/cargo@v1
        with:
          command: run
          args: --release
        env:
          MKLROOT: ${{ github.workspace }}
